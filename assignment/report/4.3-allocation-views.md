# G√≥c Nh√¨n Ph√¢n B·ªï (Allocation Views)

## M·ª•c Ti√™u

G√≥c nh√¨n n√†y m√¥ t·∫£:
- **Deployment Strategy:** C√°ch c√°c services ƒë∆∞·ª£c tri·ªÉn khai l√™n infrastructure
- **Resource Allocation:** Ph√¢n b·ªï t√†i nguy√™n (CPU, memory, storage)
- **Data Distribution:** Chi·∫øn l∆∞·ª£c l∆∞u tr·ªØ d·ªØ li·ªáu (Polyglot Persistence)
- **Scalability & Availability:** ƒê·∫£m b·∫£o AC2 v√† kh·∫£ nƒÉng ch·ªãu l·ªói

---

## 1. S∆° ƒê·ªì Tri·ªÉn Khai (Deployment Diagram)

### 1.1. M√¥ T·∫£ T·ªïng Quan

S∆° ƒë·ªì n√†y minh h·ªça c√°ch c√°c **Microservices** ƒë∆∞·ª£c tri·ªÉn khai tr√™n m√¥i tr∆∞·ªùng **Cloud** s·ª≠ d·ª•ng:
- **Kubernetes (K8s):** Container orchestration
- **Containerization (Docker):** ƒê√≥ng g√≥i services
- **Blue/Green Deployment:** Cho services AI quan tr·ªçng (FR9, FR12)

**M·ª•c ti√™u:**
- ‚úÖ ƒê√°p ·ª©ng **Scalability (AC2):** Auto-scaling theo t·∫£i
- ‚úÖ ƒê√°p ·ª©ng **Deployability (AC5):** Independent deployment, zero-downtime
- ‚úÖ ƒê√°p ·ª©ng **Availability:** High availability v·ªõi redundancy

### 1.2. Gi·∫£ ƒê·ªãnh K·ªπ Thu·∫≠t

| **Aspect** | **Technology/Strategy** |
|------------|-------------------------|
| **Cloud Provider** | AWS / GCP / Azure (cloud-agnostic via Kubernetes) |
| **Container Orchestration** | Kubernetes (K8s) cluster |
| **Container Runtime** | Docker / containerd |
| **Load Balancing** | Kubernetes Ingress + Cloud Load Balancer |
| **Auto-scaling** | Horizontal Pod Autoscaler (HPA) |
| **Deployment Strategy** | Blue/Green for AI services, Rolling update for others |
| **Service Mesh** | Istio (optional, for advanced traffic management) |

### 1.3. Ph√¢n T√≠ch Tri·ªÉn Khai V·∫≠t L√Ω

| **Th√†nh Ph·∫ßn H·∫° T·∫ßng** | **Vai Tr√≤ Trong ITS** | **C·ªßng C·ªë ACs** |
|------------------------|----------------------|-----------------|
| **Ingress Controller /<br>Load Balancer** | - Entry point cho external traffic<br>- SSL/TLS termination<br>- Ph√¢n ph·ªëi t·∫£i ƒë·∫øn API Gateway Pods | **AC2:** Scalability - Horizontal scaling<br>**AC6:** Security - HTTPS enforcement |
| **API Gateway Pods<br>(N ‚â• 2)** | - Stateless gateway<br>- Authentication & routing<br>- Rate limiting | **AC2:** Scalability - Auto-scaling<br>**AC5:** Deployability - Rolling updates |
| **Adaptive Engine Pods<br>(N ‚â• 3)** | - AI/ML workloads<br>- CPU-intensive computations<br>- **Blue/Green deployment** support | **AC2:** Scalability - Independent scaling<br>**AC5:** Deployability - Live model swapping (FR9)<br>**AC3:** Performance - Multiple replicas |
| **Scoring/Feedback Pods<br>(N ‚â• 3)** | - Real-time scoring<br>- High throughput<br>- Low latency requirement (‚â§500ms) | **AC2:** Scalability - Handle burst traffic<br>**AC3:** Performance - Fast response |
| **Learner Model Pods<br>(N ‚â• 2)** | - Event consumers<br>- Model update processing<br>- NoSQL database access | **AC2:** Scalability - Process events async<br>**AC1:** Modularity - Decoupled via events |
| **Content Service Pods<br>(N ‚â• 2)** | - Serve learning materials<br>- Read-heavy workload<br>- Cache-friendly | **AC7:** Availability - Always available<br>**AC3:** Performance - With caching layer |
| **User Management Pods<br>(N ‚â• 2)** | - Authentication & authorization<br>- RBAC management<br>- Critical service | **AC6:** Security - User data protection<br>**AC7:** Availability - Always online |
| **Kafka Cluster<br>(N ‚â• 3 brokers)** | - Event streaming platform<br>- Decouple services<br>- High throughput messaging | **AC2:** Scalability - Handle millions of events<br>**AC1:** Modularity - Async communication |
| **Persistent Storage<br>Cluster** | - Databases (SQL & NoSQL)<br>- File storage (S3/GCS)<br>- Backup & recovery | **AC6:** Security - Data isolation<br>**AC7:** Availability - Data redundancy |
| **Redis Cache Cluster<br>(N ‚â• 2)** | - In-memory caching<br>- Session storage<br>- Hot data caching | **AC3:** Performance - Sub-ms latency<br>**AC2:** Scalability - Reduce DB load |

### 1.4. S∆° ƒê·ªì Deployment (Mermaid)

```mermaid
flowchart TB

subgraph Internet["üåê Internet"]
    Users[üë§ Users<br/>Web/Mobile Clients]
end

subgraph CloudProvider["‚òÅÔ∏è Cloud Provider (AWS/GCP/Azure)"]
    
    subgraph LoadBalancer["Load Balancer"]
        LB[Cloud LB<br/>SSL Termination]
    end
    
    subgraph K8sCluster["üéØ Kubernetes Cluster"]
        
        subgraph Ingress["Ingress Layer"]
            IC[Ingress Controller<br/>NGINX/Traefik]
        end
        
        subgraph ApplicationPods["Application Pods (Auto-scaled)"]
            
            subgraph GatewayLayer["API Gateway"]
                GW1[Gateway Pod 1]
                GW2[Gateway Pod 2]
            end
            
            subgraph AIServices["AI Services (Blue/Green)"]
                direction LR
                subgraph Blue["Blue Environment"]
                    AE1[Adaptive Engine v1.0<br/>Pod 1]
                    AE2[Adaptive Engine v1.0<br/>Pod 2]
                end
                subgraph Green["Green Environment"]
                    AE3[Adaptive Engine v1.1<br/>Pod 1]
                    AE4[Adaptive Engine v1.1<br/>Pod 2]
                end
            end
            
            subgraph ScoringLayer["Scoring Services"]
                SC1[Scoring Pod 1]
                SC2[Scoring Pod 2]
                SC3[Scoring Pod 3]
            end
            
            subgraph ContentLayer["Content Services"]
                CT1[Content Pod 1]
                CT2[Content Pod 2]
            end
            
            subgraph LearnerLayer["Learner Model Services"]
                LM1[Learner Model Pod 1]
                LM2[Learner Model Pod 2]
            end
            
            subgraph UserLayer["User Management"]
                UM1[User Mgmt Pod 1]
                UM2[User Mgmt Pod 2]
            end
        end
        
        subgraph MessagingLayer["Messaging Layer"]
            K1[Kafka Broker 1]
            K2[Kafka Broker 2]
            K3[Kafka Broker 3]
        end
        
        subgraph CacheLayer["Cache Layer"]
            R1[(Redis Master)]
            R2[(Redis Replica)]
        end
        
    end
    
    subgraph DataLayer["üíæ Persistent Storage (Outside K8s)"]
        subgraph SQL["Relational Databases"]
            PG1[(PostgreSQL Primary)]
            PG2[(PostgreSQL Standby)]
        end
        
        subgraph NoSQL["NoSQL Databases"]
            MG1[(MongoDB Primary)]
            MG2[(MongoDB Secondary)]
        end
        
        subgraph ObjectStorage["Object Storage"]
            S3[(S3/GCS<br/>Static Content)]
        end
    end
    
end

%% Connections
Users -->|HTTPS| LB
LB --> IC
IC --> GW1 & GW2
GW1 & GW2 --> Blue & Green
GW1 & GW2 --> SC1 & SC2 & SC3
GW1 & GW2 --> CT1 & CT2
GW1 & GW2 --> LM1 & LM2
GW1 & GW2 --> UM1 & UM2

SC1 & SC2 & SC3 --> K1 & K2 & K3
Blue & Green --> K1 & K2 & K3
LM1 & LM2 --> K1 & K2 & K3

UM1 & UM2 --> PG1
CT1 & CT2 --> PG1 & S3
LM1 & LM2 --> MG1

SC1 & SC2 & SC3 --> R1
CT1 & CT2 --> R1

PG1 -.Replication.-> PG2
MG1 -.Replication.-> MG2
R1 -.Replication.-> R2

%% Styling
classDef lb fill:#ff5722,stroke:#bf360c,stroke-width:3px,color:#fff
classDef gateway fill:#ff9800,stroke:#e65100,stroke-width:2px,color:#fff
classDef ai fill:#9c27b0,stroke:#4a148c,stroke-width:2px,color:#fff
classDef service fill:#2196f3,stroke:#0d47a1,stroke-width:2px,color:#fff
classDef kafka fill:#673ab7,stroke:#311b92,stroke-width:2px,color:#fff
classDef db fill:#4caf50,stroke:#1b5e20,stroke-width:2px,color:#fff
classDef cache fill:#ff9800,stroke:#e65100,stroke-width:2px,color:#fff

class LB,IC lb
class GW1,GW2 gateway
class AE1,AE2,AE3,AE4 ai
class SC1,SC2,SC3,CT1,CT2,LM1,LM2,UM1,UM2 service
class K1,K2,K3 kafka
class PG1,PG2,MG1,MG2,S3 db
class R1,R2 cache
```

### 1.5. Resource Allocation Strategy

#### **A. CPU & Memory Allocation**

| **Service** | **CPU Request** | **CPU Limit** | **Memory Request** | **Memory Limit** | **Replicas** |
|-------------|-----------------|---------------|-------------------|------------------|--------------|
| **API Gateway** | 100m | 500m | 128Mi | 512Mi | 2-5 (HPA) |
| **Adaptive Engine** | 500m | 2000m | 512Mi | 2Gi | 3-10 (HPA) |
| **Scoring Service** | 250m | 1000m | 256Mi | 1Gi | 3-8 (HPA) |
| **Learner Model** | 200m | 800m | 256Mi | 1Gi | 2-6 (HPA) |
| **Content Service** | 100m | 500m | 128Mi | 512Mi | 2-4 (HPA) |
| **User Management** | 100m | 500m | 128Mi | 512Mi | 2-3 | 
| **Kafka Broker** | 500m | 2000m | 1Gi | 4Gi | 3 (StatefulSet) |
| **Redis** | 100m | 500m | 256Mi | 1Gi | 2 (Master-Replica) |

**Ch√∫ th√≠ch:**
- **Request:** Minimum guaranteed resources
- **Limit:** Maximum allowed resources
- **HPA:** Horizontal Pod Autoscaler (auto-scale based on metrics)

#### **B. Auto-scaling Configuration**

**Horizontal Pod Autoscaler (HPA) Rules:**

```yaml
# Example: Adaptive Engine Service
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: adaptive-engine-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: adaptive-engine
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: "1000"
```

**Scaling Triggers:**

| **Service** | **Scale Up When** | **Scale Down When** | **Cooldown** |
|-------------|-------------------|---------------------|--------------|
| Adaptive Engine | CPU > 70% OR Requests > 1000/s | CPU < 30% AND Requests < 300/s | 5 min |
| Scoring Service | CPU > 70% OR Latency > 400ms | CPU < 30% AND Latency < 100ms | 3 min |
| Learner Model | Queue depth > 1000 messages | Queue depth < 100 messages | 5 min |

---

## 2. Blue/Green Deployment Strategy

### 2.1. Concept

**Blue/Green Deployment** cho ph√©p:
- ‚úÖ **Zero-downtime deployment**
- ‚úÖ **Live AI model swapping** (FR9, FR12)
- ‚úÖ **Instant rollback** n·∫øu c√≥ l·ªói

### 2.2. Implementation for Adaptive Engine

**Lu·ªìng Deployment:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 1: Both Blue (v1.0) and Green (v1.1) Running          ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ  Traffic: 100% ‚Üí Blue (v1.0)                                ‚îÇ
‚îÇ  Green (v1.1): Running but no traffic (testing phase)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 2: Gradual Traffic Shift (Canary)                     ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ  Traffic: 90% ‚Üí Blue, 10% ‚Üí Green                           ‚îÇ
‚îÇ  Monitor metrics: latency, error rate, accuracy             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 3: Full Cutover                                       ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ  Traffic: 100% ‚Üí Green (v1.1)                               ‚îÇ
‚îÇ  Blue (v1.0): Keep running for 1 hour (rollback window)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STEP 4: Decommission Old Version                           ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ  Traffic: 100% ‚Üí Green (v1.1)                               ‚îÇ
‚îÇ  Blue (v1.0): Terminated                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.3. Kubernetes Configuration

**Service with selector switching:**

```yaml
# Kubernetes Service (traffic routing)
apiVersion: v1
kind: Service
metadata:
  name: adaptive-engine-service
spec:
  selector:
    app: adaptive-engine
    version: blue  # Switch to 'green' for cutover
  ports:
  - port: 8080
    targetPort: 8080
```

**Blue Deployment:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adaptive-engine-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: adaptive-engine
      version: blue
  template:
    metadata:
      labels:
        app: adaptive-engine
        version: blue
    spec:
      containers:
      - name: adaptive-engine
        image: adaptive-engine:v1.0
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi
```

**Green Deployment:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adaptive-engine-green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: adaptive-engine
      version: green
  template:
    metadata:
      labels:
        app: adaptive-engine
        version: green
    spec:
      containers:
      - name: adaptive-engine
        image: adaptive-engine:v1.1  # New version
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi
```

---

## 3. S∆° ƒê·ªì Ph√¢n B·ªï D·ªØ Li·ªáu (Polyglot Persistence)

### 3.1. Chi·∫øn L∆∞·ª£c Polyglot Persistence

**Concept:** S·ª≠ d·ª•ng **nhi·ªÅu lo·∫°i c∆° s·ªü d·ªØ li·ªáu kh√°c nhau** ƒë·ªÉ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t v√† t√≠nh linh ho·∫°t cho t·ª´ng service.

**Benefits:**
- ‚úÖ **Optimized for use case:** M·ªói DB ph√π h·ª£p v·ªõi data model
- ‚úÖ **Independent scaling:** Scale DB theo nhu c·∫ßu c·ªßa t·ª´ng service
- ‚úÖ **Fault isolation:** L·ªói DB kh√¥ng lan t·ªèa

### 3.2. Ph√¢n B·ªï D·ªØ Li·ªáu Chi Ti·∫øt

| **Service** | **D·ªØ Li·ªáu Qu·∫£n L√Ω** | **Lo·∫°i C∆° S·ªü D·ªØ Li·ªáu** | **L√Ω Do T·ªëi ∆Øu H√≥a (ACs)** |
|-------------|---------------------|-------------------------|----------------------------|
| **User Management** | - `User` entity<br>- `Role` & `Permission`<br>- Authentication tokens | **Relational DB**<br>(PostgreSQL) | **AC6:** Security - ACID properties ƒë·∫£m b·∫£o data integrity cho th√¥ng tin x√°c th·ª±c quan tr·ªçng<br>**AC7:** Availability - Mature replication & backup |
| **Learner Model** | - `LearnerModel` entity<br>- `SkillMasteryScore`<br>- Learning analytics | **NoSQL Document DB**<br>(MongoDB) | **AC1:** Modularity - Flexible schema cho AI model attributes<br>**AC2:** Scalability - Horizontal scaling cho millions of learners<br>**Flexibility:** D·ªÖ d√†ng th√™m fields m·ªõi (Confidence Score, Learning Style) |
| **Content Service** | - `LearningContent` entity<br>- `MetadataTag`<br>- Content versioning | **Relational DB**<br>(PostgreSQL)<br>+<br>**Object Storage**<br>(S3/GCS) | **PostgreSQL:** Relational queries for metadata<br>**S3:** Static files (videos, PDFs, images)<br>**AC7:** Availability - Content always accessible<br>**Cost:** Object storage cheaper for large files |
| **Scoring/Feedback** | - Assessment rules<br>- Grading criteria<br>- Hint templates | **Key-Value Store**<br>(Redis) | **AC3:** Performance - Sub-millisecond access<br>**Caching:** Reduce latency for hot data<br>**TTL:** Auto-expire old cache entries |
| **Adaptive Engine** | - Temporary computation state<br>- Session data | **In-Memory Cache**<br>(Redis) | **AC3:** Performance - Fast state access for AI algorithms<br>**Stateless:** Can restart pods without data loss (cache can be rebuilt) |
| **Event Store<br>(Optional)** | - Event history<br>- Audit logs<br>- Event sourcing | **Event Store DB**<br>(EventStoreDB)<br>or<br>**Kafka + Compaction** | **AC7:** Availability - Event replay capability<br>**Debugging:** Full event history for troubleshooting<br>**Compliance:** Audit trail |

### 3.3. Database Specifications

#### **PostgreSQL (Relational DB)**

**Configuration:**
- **Primary-Standby Replication:** 1 primary + 1 standby
- **Backup Strategy:** Daily full backup + continuous WAL archiving
- **Connection Pooling:** PgBouncer (max 100 connections per service)
- **Storage:** SSD (for low latency)

**Services Using:**
- User Management
- Content Service

#### **MongoDB (NoSQL Document DB)**

**Configuration:**
- **Replica Set:** 3 nodes (1 primary + 2 secondaries)
- **Sharding:** Shard by `learnerId` when > 10M learners
- **Write Concern:** `majority` (ensure durability)
- **Read Preference:** `primaryPreferred` (consistency)

**Services Using:**
- Learner Model Service

**Schema Example:**
```json
{
  "_id": "learner_12345",
  "name": "John Doe",
  "skillMastery": {
    "math_algebra": 0.85,
    "math_calculus": 0.62
  },
  "learningStyle": "visual",
  "confidenceScore": 0.78,
  "lastUpdated": "2025-10-13T10:30:00Z",
  "metadata": {
    // Flexible fields can be added without schema migration
    "preferredDifficulty": "medium",
    "avgSessionTime": 45
  }
}
```

#### **Redis (Key-Value Store & Cache)**

**Configuration:**
- **Deployment:** Master-Replica (1 master + 1 replica)
- **Persistence:** RDB snapshots (every 5 min) + AOF (append-only file)
- **Eviction Policy:** `allkeys-lru` (Least Recently Used)
- **Max Memory:** 2GB per instance

**Use Cases:**
- **Cache:** Assessment rules, content metadata
- **Session Store:** User sessions, temp state
- **Rate Limiting:** API rate limits (sliding window)

**Data Examples:**
```redis
# Assessment rule cache
assessment:rule:123 ‚Üí "{correctAnswer: 'B', points: 10, hints: [...]}"

# Rate limiting (sliding window)
rate_limit:user:456:window:1697185200 ‚Üí "15"  (15 requests in this window)

# Session
session:abc123 ‚Üí "{userId: 789, role: 'learner', exp: 1697188800}"
```

#### **S3/GCS (Object Storage)**

**Configuration:**
- **Bucket Structure:**
  - `its-content-prod/videos/`
  - `its-content-prod/pdfs/`
  - `its-content-prod/images/`
- **CDN:** CloudFront (AWS) / Cloud CDN (GCP) for global distribution
- **Lifecycle Policy:** Archive to Glacier after 1 year
- **Versioning:** Enabled (for content rollback)

**Services Using:**
- Content Service (static files)

### 3.4. Data Flow Diagram

```mermaid
flowchart LR

subgraph Services["Microservices"]
    UM[User Management]
    CS[Content Service]
    LM[Learner Model]
    SS[Scoring Service]
    AE[Adaptive Engine]
end

subgraph Databases["Polyglot Persistence"]
    PG[(PostgreSQL<br/>ACID, Relational)]
    MG[(MongoDB<br/>Flexible Schema)]
    RD[(Redis<br/>Cache & KV)]
    S3[(S3/GCS<br/>Object Storage)]
end

UM -->|Users, Roles| PG
CS -->|Metadata| PG
CS -->|Static Files| S3
LM -->|Learner Models| MG
SS -->|Cache Rules| RD
AE -->|Temp State| RD

classDef service fill:#2196f3,stroke:#0d47a1,stroke-width:2px,color:#fff
classDef db fill:#4caf50,stroke:#1b5e20,stroke-width:2px,color:#fff

class UM,CS,LM,SS,AE service
class PG,MG,RD,S3 db
```

---

## 4. Mapping T·ªõi Architecture Characteristics

### 4.1. Allocation View Supports ACs

| **Architecture Characteristic** | **How Allocation View Supports It** |
|---------------------------------|--------------------------------------|
| **AC1: Modularity** | - Each service has dedicated pods<br>- Independent deployment pipelines<br>- Polyglot persistence (DB per service) |
| **AC2: Scalability** | - Kubernetes HPA (auto-scaling)<br>- Horizontal scaling for stateless services<br>- MongoDB sharding for data<br>- Kafka partitioning for events |
| **AC3: Performance** | - Redis caching reduces DB load<br>- CDN for static content<br>- Resource limits prevent noisy neighbors<br>- SSD storage for low latency |
| **AC5: Deployability** | - Blue/Green deployment for AI services<br>- Rolling updates for others<br>- Independent versioning per service<br>- Zero-downtime deployment |
| **AC6: Security** | - Network policies (pod-to-pod isolation)<br>- Secrets management (K8s Secrets)<br>- Database encryption at rest<br>- TLS for inter-service communication |
| **AC7: Availability** | - Multiple replicas per service (N ‚â• 2)<br>- Database replication (primary-standby)<br>- Health checks & auto-restart<br>- Backup & disaster recovery |

### 4.2. Infrastructure Cost Estimation

**Monthly Cost Breakdown (Estimated for 10,000 concurrent users):**

| **Component** | **Configuration** | **Monthly Cost** |
|---------------|-------------------|------------------|
| **Kubernetes Cluster** | 3 nodes (8 vCPU, 32GB RAM each) | $600 |
| **Load Balancer** | 1 instance | $30 |
| **PostgreSQL** | Primary + Standby (4 vCPU, 16GB) | $200 |
| **MongoDB** | 3-node replica set (4 vCPU, 16GB each) | $450 |
| **Redis** | Master + Replica (2 vCPU, 4GB each) | $100 |
| **Kafka** | 3 brokers (4 vCPU, 8GB each) | $300 |
| **S3/Object Storage** | 1TB storage + transfer | $100 |
| **CDN** | CloudFront/Cloud CDN | $50 |
| **Monitoring & Logging** | Datadog/New Relic | $150 |
| **Backup & DR** | Automated backups | $50 |
| **Total** | | **~$2,030/month** |

**Scaling Projections:**

| **Users** | **Cluster Nodes** | **Est. Monthly Cost** |
|-----------|-------------------|-----------------------|
| 10,000 | 3 nodes | $2,030 |
| 50,000 | 6 nodes | $3,500 |
| 100,000 | 12 nodes | $6,200 |

---

## 5. K·∫øt Lu·∫≠n

### 5.1. Key Takeaways

**Allocation View ƒë√£ ch·ª©ng minh:**

1. ‚úÖ **Cloud-Native Architecture:**
   - Kubernetes orchestration cho flexibility v√† portability
   - Container-based deployment cho consistency
   - Auto-scaling cho cost optimization

2. ‚úÖ **Polyglot Persistence Strategy:**
   - PostgreSQL cho transactional data (ACID)
   - MongoDB cho flexible learner models
   - Redis cho high-performance caching
   - S3 cho cost-effective static content storage

3. ‚úÖ **High Availability & Scalability:**
   - Multiple replicas (N ‚â• 2) cho m·ªçi service
   - Database replication cho data redundancy
   - Auto-scaling based on metrics (CPU, memory, requests)

4. ‚úÖ **Zero-Downtime Deployment:**
   - Blue/Green deployment cho AI services (FR9)
   - Rolling updates cho stateless services
   - Instant rollback capability

### 5.2. Trade-offs & Decisions

| **Decision** | **Rationale** | **Trade-off Accepted** |
|--------------|---------------|------------------------|
| **Kubernetes over VMs** | Orchestration, auto-scaling, portability | Higher complexity, learning curve |
| **Polyglot Persistence** | Optimized for each use case | Multiple DB technologies to manage |
| **Blue/Green Deployment** | Zero downtime for AI model swapping | Higher resource usage (2x during deployment) |
| **Managed K8s (GKE/EKS)** | Reduced operational overhead | Higher cost vs self-managed |

### 5.3. Operational Considerations

**DevOps Requirements:**
- ‚úÖ CI/CD pipeline (GitLab CI, Jenkins, or GitHub Actions)
- ‚úÖ Infrastructure as Code (Terraform, Helm charts)
- ‚úÖ Monitoring & Alerting (Prometheus, Grafana, Datadog)
- ‚úÖ Logging (ELK stack or Cloud Logging)
- ‚úÖ Distributed Tracing (Jaeger, Zipkin)

**Team Skills Needed:**
- Kubernetes administration
- Container orchestration
- Database management (SQL & NoSQL)
- Cloud platform expertise (AWS/GCP/Azure)
- Security best practices

---

**T√†i li·ªáu tham kh·∫£o:**
- Kubernetes in Action (Marko Luk≈°a)
- Site Reliability Engineering (Google)
- Designing Data-Intensive Applications (Martin Kleppmann)
- Cloud Native Patterns (Cornelia Davis)
